*start*06933 00024 USfReturn-Path: <CL-Cleanup-mailer@SAIL.Stanford.EDU>Redistributed: xerox-cl-cleanup^.paReceived: from SAIL.Stanford.EDU ([36.86.0.194]) by Xerox.COM ; 22 DEC 88 15:46:49 PSTReceived: from STONY-BROOK.SCRC.Symbolics.COM (SCRC-STONY-BROOK.ARPA) by SAIL.Stanford.EDU with TCP; 22 Dec 88  15:45:39 PSTReceived: from BOBOLINK.SCRC.Symbolics.COM by STONY-BROOK.SCRC.Symbolics.COM via INTERNET with SMTP id 511675; 22 Dec 88 18:44:30 ESTDate: Thu, 22 Dec 88 18:44 ESTFrom: Kent M Pitman <KMP@STONY-BROOK.SCRC.Symbolics.COM>Subject: Issue: BACKQUOTE-COMMA-ATSIGN-DOT-COMMA (Version 1)To: CL-Cleanup@SAIL.Stanford.EDUMessage-ID: <881222184414.5.KMP@BOBOLINK.SCRC.Symbolics.COM>Michael Greenwald at Symbolics raised this issue on the Common-Lispmailing list. I ran this proposal draft by him. He agrees the writeupexpresses the issue he was trying to raise, and he says he has nopreference for which of the two proposals is adopted.  He just wantsus to take some definitive position so he'll know what to implementfor Genera. He asked not to be cc'd in the mail from this point out. -kmp-----Issue:        BACKQUOTE-COMMA-ATSIGN-DOT-COMMAForum:	      CleanupReferences:   Back quote (pp349-351)Category:     CLARIFICATION/CHANGEEdit history: 22-Dec-88, Version 1 by PitmanStatus:	      For Internal DiscussionProblem Description:  The consistent description of backquote has been disrupted by   recent changes in the semantics of APPEND.  The description at the bottom of p350 suggests that  `(foo ,@bar) can be legitimately interpreted as any of  #1: (list* 'foo bar)  #2: (append (list 'foo) bar)  #3: (append (list 'foo) bar '())  Unfortunately, issue APPEND-DOTTED has disrupted the equivalences  here because if BAR holds a dotted list, #1 and #2 are the same (they  preserve the `dotted cdr'), but #3 is different (it replaces the  `dotted cdr' with NIL). Under CLtL, a dotted list given to APPEND was  an error, so this case did not come up. But since ANSI CL will not make  this an error, this ambiguity must be resolved.  Proposal (BACKQUOTE-COMMA-ATSIGN-DOT-COMMA:DIVERGENT):  Define that `(x1 ... xM . ,xN) is equivalent to (LIST* x1 ... xN).  The actual (EQL) object xN will be used without copying in the result.  The result itself might not be a proper list (e.g., if xN is an  atom or dotted list).  Define that `(x1 ... xM ,@xN) is equivalent to   (APPEND (LIST 'x1) ... (list 'xM) xN '()).  Any top-level list structure of the object xN will be copied in the  result, replacing (CDR (LAST xN)) with NIL (or replacing xN itself  with NIL if xN is an atom and issue APPEND-ATOM passes).Proposal (BACKQUOTE-COMMA-ATSIGN-DOT-COMMA:INTERCHANGEABLE):  Define that `(x1 ... xM . ,xN) is equivalent to (LIST* x1 ... xN).  The actual (EQL) object xN will be used without copying in the result.  The result itself might not be a proper list (e.g., if xN is an  atom or dotted list).  Define that `(x1 ... xM ,@xN) is equivalent to   (APPEND (LIST 'x1) ... (list 'xM) xN).  The actual (EQL) object xN will be used without copying in the result.  The result itself might not be a proper list (e.g., if xN is an  atom or dotted list).Notes:  Note well that this has implications which go beyond dotted lists.  Currently, `(FOO ,@X) may be implemented by either     (LIST* 'FOO X)  or (APPEND (LIST 'FOO) X '())  or (APPEND (LIST 'FOO) X)  A consequence of the proposals above is to distinguish between  the two APPEND cases, forcing changes in the side-effect behavior  of backquoted structures currently exhibited by some implementations.Test Cases:  ;; Issue #1: Non-side-effect treatment of dotted lists.  (LET ((DOTTED (LIST* 'A 'B 'C)))    (VALUES `(FOO ,@DOTTED)	    `(FOO . ,DOTTED)))    => (FOO A B),      (FOO A B . C)		;under proposal DIVERGENT  => (FOO A B . C),  (FOO A B . C)		;under proposal INTERCHANGEABLE  ;; Issue #2a: Side-effects  ;; Sometimes called the ``Standard Backquote Screw''  ;; Structure is unintentionally shared.  (LET ((TAIL1 (LIST 'A 'B 'C))	(TAIL2 (LIST 'A 'B 'C)))    (FLET ((GET-XABC-COMMA-ATSIGN () `(X ,@TAIL1))	   (GET-XABC-DOT-COMMA    () `(X . ,TAIL2)))      (LET ((TEMP1 (GET-XABC-COMMA-ATSIGN))	    (TEMP2 (GET-XABC-DOT-COMMA)))	(SETF (CADDR TEMP1) 'Z)	(SETF (CADDR TEMP2) 'Z)	(VALUES TEMP1 (GET-XABC-COMMA-ATSIGN)		TEMP2 (GET-XABC-DOT-COMMA)))))  => (X A Z C), (X A B C), (X A Z C), (X A Z C) ;under proposal DIVERGENT  => (X A Z C), (X A Z C), (X A Z C), (X A Z C) ;under proposal INTERCHANGEABLE  ;; Issue #2b: Side-effects  ;; Sometimes called ``Inverse Backquote Screw''  ;; Structure is unintentionally copied.  (LET ((VAR 'X)	(VAL '7)	(THE-SETQ-TAIL (LIST NIL NIL)))    (LET ((COMMA-ATSIGN `(SETQ ,@THE-SETQ-TAIL))	  (DOT-COMMA    `(SETQ . ,THE-SETQ-TAIL)))      (SETF (CAR  SETQ-TAIL) VAR)      (SETF (CADR SETQ-TAIL) VAL)      (VALUES COMMA-ATSIGN DOT-COMMA)  => (SETQ NIL NIL), (SETQ X 7)			; under proposal DIVERGENT  => (SETQ X 7),     (SETQ X 7)			; under proposal INTERCHANGEABLERationale:  This clarifies an ambiguity in the description of the language which was caused  by issue APPEND-DOTTED and APPEND-ATOM.  Although CLtL tries not to specify the sharing and side-effect implications  of backquote, there is no really principled reason for its failure to do so.  In practice, the failure to do so leads to gratuitous portability barriers.  Current Practice:  Currently, the definition of APPEND is such that it would be an error  to pass it a dotted list, so there is no possibility of discrepancy  because the interesting case is an "is an error" case.Cost to Implementors:  Very small. Some implementations would need to change how they implement  backquote. Presumably this is a very isolated change.Cost to Users:  Technically, none. Existing code is not supposed to rely on the distinctions  discussed here. The distinction will only be meaningful when ANSI CL goes into  effect.  In practice, since some implementations will have to change incompatibly,  some code which accidentally relies on the current behavior will break.  However, once such code is fixed, it will be more portable because   implementations will not gratuitously diverge.Cost of Non-Adoption:  An ambiguity would exist in the language, confusing both users and  implementors.Benefits:  An ambiguity would be removed.  Some gratuitous barriers to portability would be removed.Aesthetics:  Proposal DIVERGENT makes things slightly harder to learn.  Both proposals make things more predictably portable, which presumably  has some aesthetic appeal.Discussion:  Pitman thinks that either of these choices will be better than the status quo.  Given that some people already think of ., and ,@ as interchangeable and merely  a matter of personal style, it would be better to go with option INTERCHANGEABLE.*start*03179 00024 US Return-Path: <CL-Cleanup-mailer@SAIL.Stanford.EDU>Redistributed: xerox-cl-cleanup^.paReceived: from SAIL.Stanford.EDU ([36.86.0.194]) by Xerox.COM ; 28 DEC 88 16:21:20 PSTReceived: from lucid.com by SAIL.Stanford.EDU with TCP; 27 Dec 88  12:08:57 PSTReceived: from bhopal ([192.9.200.13]) by heavens-gate.lucid.com id AA00336g; Mon, 26 Dec 88 22:12:24 PSTReceived: by bhopal id AA01403g; Mon, 26 Dec 88 22:13:04 PSTDate: Mon, 26 Dec 88 22:13:04 PSTFrom: Jon L White <jonl@lucid.com>Message-Id: <8812270613.AA01403@bhopal>To: KMP@STONY-BROOK.SCRC.Symbolics.COMCc: CL-Cleanup@SAIL.Stanford.EDUIn-Reply-To: Kent M Pitman's message of Thu, 22 Dec 88 18:44 EST <881222184414.5.KMP@BOBOLINK.SCRC.Symbolics.COM>Subject: Issue: BACKQUOTE-COMMA-ATSIGN-DOT-COMMA (Version 1)re    Cost to Users:      Technically, none. Existing code is not supposed to rely on ...Not so!  The language of the last line on P.350 of CLtL make it clear that implementations are currently free to take either choice mentionedin the two proposals.  Since not everyone restricts himself to writingonly portable-by-the-book CLtL code, then many users will in fact take advantage of the particular choices made by the implementation they use.[Witness the number of Symbolics users who unknowingly adjust arrays that were made without the :adjustable option].Selecting only one the two alternatives of P.350 will invalidate thoseimplementations that have taken the other choice; so either proposalwill shaft some community of users (i.e., those who have never ported their code between vendors that took different paths on the P.350question).  I know, because we just went through such an exercise hereat Lucid not too long ago.  Far too many places depended on theequivalence of ., and ,. -- that the last form *not* be NCONC'd withwith NIL -- and at least a couple places actually depended upon a final ,@ giving shared structure (for updates to be communally visible).Incidentally, Lucid adopted a view towards non-standard lists long, long ago that forced it to resolve the APPEND-DOTTED issue for itself; thus it is not true of "Current Practice:" that there is "no possibility of discrepancy".  I'm not necessarily defending that view of dotted-lists -- merely pointing out that Lucid's decision back in October 1984 makes the INTERCHANGEABLE proposable infeasible without backing out of infinitely-many more dotted-list type decisions.  ["infinitely-many more" means that we worried about just this issue sometime in late 1986, and decided we didn't have the manpower to resolve it, since it turns up pervasively throughout the system.]  In defence of the 1984 decision, someone who was here at the time claimed that they personally asked Guy Steele about that interpretation,and that "he approved".  Perhaps no one was concerned back then with theexamples on ClTL P.351.I actually think the DIVERGENT proposal is simpler to understand:   (1) ,@ always copies -- not to worry about being "at the end"   (2) ,. always NCONC's and ., never NCONC's -- not to worry about       situations that would switch meanings.-- JonL --*start*01253 00024 US Return-Path: <CL-Cleanup-mailer@SAIL.Stanford.EDU>Redistributed: xerox-cl-cleanup^.paReceived: from SAIL.Stanford.EDU ([36.86.0.194]) by Xerox.COM ; 29 DEC 88 18:36:55 PSTReceived: from ti.com by SAIL.Stanford.EDU with TCP; 29 Dec 88  18:33:53 PSTReceived: by ti.com id AA06901; Thu, 29 Dec 88 20:33:36 CSTReceived: from dsg by tilde id AA24175; Thu, 29 Dec 88 20:22:52 CSTReceived: From Kelvin By dsg Via CHAOS-NET With CHAOS-MAIL; Thu, 29 Dec 88  20:20:40 CSTMessage-Id: <2808440631-7583328@Kelvin>Sender: GRAY@Kelvin.csc.ti.comDate: Thu, 29 Dec 88 20:23:51 CSTFrom: David N Gray <Gray@DSG.csc.ti.com>To: Kent M Pitman <KMP@STONY-BROOK.SCRC.Symbolics.COM>Cc: CL-Cleanup@SAIL.Stanford.EDUSubject: Re: Issue: BACKQUOTE-COMMA-ATSIGN-DOT-COMMA (Version 1)In-Reply-To: Msg of Thu, 22 Dec 88 18:44 EST from Kent M Pitman <KMP@STONY-BROOK.SCRC.Symbolics.COM>I ran all of the test cases on an Explorer and found that the results wereall consistent with proposalBACKQUOTE-COMMA-ATSIGN-DOT-COMMA:INTERCHANGEABLE, so I would have toprefer that alternative, although I don't know who might be depending onthat behavior.The INTERCHANGEABLE alternative also has a performance advantage by doingless copying of lists.*start*01973 00024 USaReturn-Path: <CL-Cleanup-mailer@SAIL.Stanford.EDU>Redistributed: xerox-cl-cleanup^.paReceived: from SAIL.Stanford.EDU ([36.86.0.194]) by Xerox.COM ; 30 DEC 88 02:34:16 PSTReceived: from lucid.com by SAIL.Stanford.EDU with TCP; 30 Dec 88  02:34:03 PSTReceived: from bhopal ([192.9.200.13]) by heavens-gate.lucid.com id AA01499g; Fri, 30 Dec 88 02:29:35 PSTReceived: by bhopal id AA13596g; Fri, 30 Dec 88 02:31:41 PSTDate: Fri, 30 Dec 88 02:31:41 PSTFrom: Jon L White <jonl@lucid.com>Message-Id: <8812301031.AA13596@bhopal>To: Gray@DSG.csc.ti.comCc: KMP@STONY-BROOK.SCRC.Symbolics.COM, CL-Cleanup@SAIL.Stanford.EDUIn-Reply-To: David N Gray's message of Thu, 29 Dec 88  20:23:51 CST <2808440631-7583328@Kelvin>Subject: Issue: BACKQUOTE-COMMA-ATSIGN-DOT-COMMA (Version 1)re: I ran all of the test cases on an Explorer and found that the results were    all consistent with proposal    BACKQUOTE-COMMA-ATSIGN-DOT-COMMA:INTERCHANGEABLE . . .It's highly probably that all "spiritual descendents" of MacLisp havethis behaviour, because they all probably copied the optimization thattreats ",."  ",@" and ".," the same when found at the penultimate position of a list.  ["backquote" evolved during the mid-1970's atMIT in the AI and LCS labs].Steele's book was the first to formalize the meaning of backquote, withhis meta-language on p.350.  From this discussion, it is clear thatthe step   (APPEND ... (APPEND X NIL))  ==>  (APPEND ... X)is arbitrary, rather than being an inevitable part of the intendedmeaning.  Steele implies that either doing this optimization or notdoing it is fine.  But the Issue APPEND-DOTTED now seems to makethis an invalid optimization.  My feeling is that we either have to go for the discriminatory versionof BACKQUOTE-COMMA-ATSIGN-DOT-COMMA -- the one that says that ".," and",@" really don't produce the same code -- or else we have to go backto the prior state for APPEND.-- JonL --*start*00781 00024 US Return-Path: <CL-Cleanup-mailer@SAIL.Stanford.EDU>Redistributed: xerox-cl-cleanup^.paReceived: from SAIL.Stanford.EDU ([36.86.0.194]) by Xerox.COM ; 03 JAN 89 18:24:25 PSTReceived: from Xerox.COM by SAIL.Stanford.EDU with TCP; 3 Jan 89  18:20:05 PSTReceived: from Cabernet.ms by ArpaGateway.ms ; 03 JAN 89 18:17:29 PSTDate: 3 Jan 89 17:03 PSTFrom: masinter.paSubject: Re: Issue: BACKQUOTE-COMMA-ATSIGN-DOT-COMMA (Version 1)In-reply-to: Kent M Pitman <KMP@STONY-BROOK.SCRC.Symbolics.COM>'s message of Thu, 22 Dec 88 18:44 ESTTo: Kent M Pitman <KMP@STONY-BROOK.SCRC.Symbolics.COM>cc: CL-Cleanup@SAIL.Stanford.EDUMessage-ID: <890103-181729-1162@Xerox>I like INTERCHANGABLE too.I thought we might actually do more to backquote than just this.*start*00998 00024 US Return-Path: <CL-Cleanup-mailer@SAIL.Stanford.EDU>Redistributed: xerox-cl-cleanup^.paReceived: from SAIL.Stanford.EDU ([36.86.0.194]) by Xerox.COM ; 06 JAN 89 22:47:40 PSTReceived: from Xerox.COM by SAIL.Stanford.EDU with TCP; 6 Jan 89  22:45:47 PSTReceived: from Cabernet.ms by ArpaGateway.ms ; 06 JAN 89 14:04:22 PSTDate: 6 Jan 89 14:02 PSTFrom: masinter.paSubject: Re: Issue: BACKQUOTE-COMMA-ATSIGN-DOT-COMMA (Version 1)In-reply-to: Jon L White <jonl@lucid.com>'s message of Fri, 30 Dec 88 02:31:41 PSTTo: Jon L White <jonl@lucid.com>cc: Gray@DSG.csc.ti.com, KMP@STONY-BROOK.SCRC.Symbolics.COM, CL-Cleanup@SAIL.Stanford.EDUMessage-ID: <890106-140422-1103@Xerox>I fail to see the necessity of correlating the behavior of backquote withthe behavior of APPEND, since we've not ever specified that backquoteactually has to use APPEND. If your backquote currently uses APPEND, makeit use BACKQUOTE-APPEND instead which has some other semantics than APPEND.*start*00851 00024 USaReturn-Path: <jonl@lucid.com>Received: from lucid.com ([192.26.25.1]) by Xerox.COM ; 07 JAN 89 22:22:24 PSTReceived: from bhopal ([192.9.200.13]) by heavens-gate id AA08764g; Sat, 7 Jan 89 22:18:57 PSTReceived: by bhopal id AA05601g; Sat, 7 Jan 89 22:21:13 PSTDate: Sat, 7 Jan 89 22:21:13 PSTFrom: Jon L White <jonl@lucid.com>Message-Id: <8901080621.AA05601@bhopal>To: masinter.paCc: Gray@DSG.csc.ti.com, KMP@STONY-BROOK.SCRC.Symbolics.COM, CL-Cleanup@SAIL.Stanford.EDUIn-Reply-To: masinter.pa@Xerox.COM's message of 6 Jan 89 14:02 PST <890106-140422-1103@Xerox>Subject: Issue: BACKQUOTE-COMMA-ATSIGN-DOT-COMMA (Version 1)re: I fail to see the necessity of correlating the behavior of backquote with    the behavior of APPEND, since we've not ever specified that backquote ...See CLtL, pages 350-51.-- JonL --*start*01859 00024 US Date:  8 Jan 89 00:31 PSTFrom: masinter.paSubject: Re: Issue: BACKQUOTE-COMMA-ATSIGN-DOT-COMMA (Version 1)In-reply-to: Jon L White <jonl@lucid.com>'s message of Sat, 7 Jan 89 22:21:13 PSTTo: Jon L White <jonl@lucid.com>cc: masinter.pa, Gray@DSG.csc.ti.com, KMP@STONY-BROOK.SCRC.Symbolics.COM, CL-Cleanup@SAIL.Stanford.EDUI must have missed a tense there somewhere. Let me try to say it a different way:The meta-rules for backquote were derived "after the fact" as a way to explain what backquote did; the use of APPEND and the equivalences there were based on the old semantics of APPEND. Now that we've extended APPEND, we have to change the meta-rules of backquote, but not the way that backquote really works in most implementations.I think the simplest way to "fix" the proposal is to change the second meta-rule about nil to be`(x1 x2 x3 ... xn . nil) may be interpreted to mean(append [x1] [x2] [x3] ... [xn])-- rather than reducing it to a previous case.This implies that `(x1 x2 ... . ,form) as in the third meta-rule has the same interpretation as `(x1 x2 ... ,@form).This requires fixing the example, so that `((,a b) ,c ,@d)will be interpreted as(append (list (append (list a) (list 'b))) (list c) d)As far as I can tell, this is consistent with the way that Lucid Common Lisp's backquote works anyway.To: '((,a b) ,c ,@d)Lucid 3.0 says:(bq-list* (bq-cons a '(b)) c d)ibuki 01/01 says(list* (list a 'b) c d)Franz says:(list* (cons a '(b)) c d)Medley says:(il:bquote (((il:\\\, a) b) (il:\\\, c) (il:\\\,@d)))which macroexpand to (LIST* (CONS A (QUOTE (B))) C D)Somebody borrowed my Mac so I can't try Coral or Procyon, and none of the local Symbolics machines will let me remote login; but it looks like *nobody* really tries to APPEND the last structure ever, anyway.*start*03486 00024 US Return-Path: <jonl@lucid.com>Received: from lucid.com ([192.26.25.1]) by Xerox.COM ; 09 JAN 89 19:55:50 PSTReceived: from bhopal ([192.9.200.13]) by heavens-gate.lucid.com id AA01625g; Mon, 9 Jan 89 19:51:50 PSTReceived: by bhopal id AA11931g; Mon, 9 Jan 89 19:54:06 PSTDate: Mon, 9 Jan 89 19:54:06 PSTFrom: Jon L White <jonl@lucid.com>Message-Id: <8901100354.AA11931@bhopal>To: masinter.paCc: Gray@DSG.csc.ti.com, KMP@STONY-BROOK.SCRC.Symbolics.COM, CL-Cleanup@SAIL.Stanford.EDUIn-Reply-To: masinter.pa@Xerox.COM's message of 8 Jan 89 00:31 PST <890108-003143-3022@Xerox>Subject: Issue: BACKQUOTE-COMMA-ATSIGN-DOT-COMMA (Version 1)re: The meta-rules for backquote were derived "after the fact" as a way to    explain what backquote did; the use of APPEND and the equivalences there    were based on the old semantics of APPEND. Now that we've extended APPEND,    we have to change the meta-rules of backquote, . . . Your assumption here can't be true -- The MacLisp implementation (andothers) carried out the now-debased optimization; yet the meta-rulesstand.  I'm very leery of changing these meta rules unless QUUX signsoff on it -- every time I've been tempted to dicker with them, I findout that they are much deeper than a cursory glanch would suspect.  [Ithought Guy devised those "meta" rules -- if he didn't then the authorought to be consulted.]re: This requires fixing the example, so that      `((,a b) ,c ,@d)    will be interpreted as      (append (list (append (list a) (list 'b))) (list c) d)    As far as I can tell, this is consistent with the way that Lucid Common    Lisp's backquote works anyway.But that's precisely what Greenwald reported as a bug!  As I explainedin previous mail, Lucid has the bug because when the decision toreaffirm the "new" semantics for APPEND was made, no one noticed (orcared about?)  the implications for backquote.I think it would be putting the cart before the horse to try to institutionalize the now-debased optimization into the semantics ofbackquote, as a way around the bug.  The advantage of not performingthis optimization is that the user need never be confused as to whetheror not ",@" will copy its argument, or share; currently a user can't besure because of the permitted ambiguity.Note that Guy himself also acknowledged the validity of Greenwald'scomplaint -- he claims that the _examples_ are invalid rather thanthe rules.  Your proposal is just the opposite -- to keep the examplesvalid and alter the rules to contain the essence of the "optimization".    Date: Tue, 29 Nov 88 17:12:40 EST    From: gls@Think.COM    To: Greenwald@stony-brook.scrc.symbolics.com    Cc: gls@Think.COM, Greenwald@stony-brook.scrc.symbolics.com,	    common-lisp@sail.stanford.edu    In-Reply-To: Michael Greenwald's message of Tue, 29 Nov 88 14:05 EST <19881129190543.1.GREENWALD@NOEL-COWARD.SCRC.Symbolics.COM>    Subject: inconsistency in backquote spec?    . . .     Because you sent the mail out to common-lisp@sail and not to    any of the X3J13 mailing lists, I assumed that you were asking    a question about the language as defined solely by the book.    In other words, I assume that the audience for the common-lisp    mailing list has not necessarily followed all of the X3J13 work.    It is true that eventual adoption of this cleanup item [APPEND-DOTTED?]    would invalidate the examples.    --GuyGuy,  wanna comment?-- JonL --*start*06615 00024 US Date: 12 Jan 89 01:19 PSTSender: masinter.paSubject: Issue: BACKQUOTE-COMMA-ATSIGN-DOT-COMMA (Version 1)To: X3J13@Sail.Stanford.EduReply-to: cl-cleanup@sail.stanford.eduFrom: cl-cleanup@sail.stanford.educc: masinterline-fold: NoThere has been discussion on this issue not reflected in thewriteup. Some of the cost/benefit analysis misses some of theCosts to Users, for example.Status: DRAFTIssue:        BACKQUOTE-COMMA-ATSIGN-DOT-COMMAForum:	      CleanupReferences:   Back quote (pp349-351)Category:     CLARIFICATION/CHANGEEdit history: 22-Dec-88, Version 1 by PitmanProblem Description:  The consistent description of backquote has been disrupted by   recent changes in the semantics of APPEND.  The description at the bottom of p350 suggests that  `(foo ,@bar) can be legitimately interpreted as any of  #1: (list* 'foo bar)  #2: (append (list 'foo) bar)  #3: (append (list 'foo) bar '())  Unfortunately, issue APPEND-DOTTED has disrupted the equivalences  here because if BAR holds a dotted list, #1 and #2 are the same (they  preserve the `dotted cdr'), but #3 is different (it replaces the  `dotted cdr' with NIL). Under CLtL, a dotted list given to APPEND was  an error, so this case did not come up. But since ANSI CL will not make  this an error, this ambiguity must be resolved.  Proposal (BACKQUOTE-COMMA-ATSIGN-DOT-COMMA:DIVERGENT):  Define that `(x1 ... xM . ,xN) is equivalent to (LIST* x1 ... xN).  The actual (EQL) object xN will be used without copying in the result.  The result itself might not be a proper list (e.g., if xN is an  atom or dotted list).  Define that `(x1 ... xM ,@xN) is equivalent to   (APPEND (LIST 'x1) ... (list 'xM) xN '()).  Any top-level list structure of the object xN will be copied in the  result, replacing (CDR (LAST xN)) with NIL (or replacing xN itself  with NIL if xN is an atom and issue APPEND-ATOM passes).Proposal (BACKQUOTE-COMMA-ATSIGN-DOT-COMMA:INTERCHANGEABLE):  Define that `(x1 ... xM . ,xN) is equivalent to (LIST* x1 ... xN).  The actual (EQL) object xN will be used without copying in the result.  The result itself might not be a proper list (e.g., if xN is an  atom or dotted list).  Define that `(x1 ... xM ,@xN) is equivalent to   (APPEND (LIST 'x1) ... (list 'xM) xN).  The actual (EQL) object xN will be used without copying in the result.  The result itself might not be a proper list (e.g., if xN is an  atom or dotted list).Notes:  Note well that this has implications which go beyond dotted lists.  Currently, `(FOO ,@X) may be implemented by either     (LIST* 'FOO X)  or (APPEND (LIST 'FOO) X '())  or (APPEND (LIST 'FOO) X)  A consequence of the proposals above is to distinguish between  the two APPEND cases, forcing changes in the side-effect behavior  of backquoted structures currently exhibited by some implementations.Test Cases:  ;; Issue #1: Non-side-effect treatment of dotted lists.  (LET ((DOTTED (LIST* 'A 'B 'C)))    (VALUES `(FOO ,@DOTTED)	    `(FOO . ,DOTTED)))    => (FOO A B),      (FOO A B . C)		;under proposal DIVERGENT  => (FOO A B . C),  (FOO A B . C)		;under proposal INTERCHANGEABLE  ;; Issue #2a: Side-effects  ;; Sometimes called the ``Standard Backquote Screw''  ;; Structure is unintentionally shared.  (LET ((TAIL1 (LIST 'A 'B 'C))	(TAIL2 (LIST 'A 'B 'C)))    (FLET ((GET-XABC-COMMA-ATSIGN () `(X ,@TAIL1))	   (GET-XABC-DOT-COMMA    () `(X . ,TAIL2)))      (LET ((TEMP1 (GET-XABC-COMMA-ATSIGN))	    (TEMP2 (GET-XABC-DOT-COMMA)))	(SETF (CADDR TEMP1) 'Z)	(SETF (CADDR TEMP2) 'Z)	(VALUES TEMP1 (GET-XABC-COMMA-ATSIGN)		TEMP2 (GET-XABC-DOT-COMMA)))))  => (X A Z C), (X A B C), (X A Z C), (X A Z C) ;under proposal DIVERGENT  => (X A Z C), (X A Z C), (X A Z C), (X A Z C) ;under proposal INTERCHANGEABLE  ;; Issue #2b: Side-effects  ;; Sometimes called ``Inverse Backquote Screw''  ;; Structure is unintentionally copied.  (LET ((VAR 'X)	(VAL '7)	(THE-SETQ-TAIL (LIST NIL NIL)))    (LET ((COMMA-ATSIGN `(SETQ ,@THE-SETQ-TAIL))	  (DOT-COMMA    `(SETQ . ,THE-SETQ-TAIL)))      (SETF (CAR  SETQ-TAIL) VAR)      (SETF (CADR SETQ-TAIL) VAL)      (VALUES COMMA-ATSIGN DOT-COMMA)  => (SETQ NIL NIL), (SETQ X 7)			; under proposal DIVERGENT  => (SETQ X 7),     (SETQ X 7)			; under proposal INTERCHANGEABLERationale:  This clarifies an ambiguity in the description of the language which was caused  by issue APPEND-DOTTED and APPEND-ATOM.  Although CLtL tries not to specify the sharing and side-effect implications  of backquote, there is no really principled reason for its failure to do so.  In practice, the failure to do so leads to gratuitous portability barriers.  Current Practice:  Currently, the definition of APPEND is such that it would be an error  to pass it a dotted list, so there is no possibility of discrepancy  because the interesting case is an "is an error" case.Cost to Implementors:  Very small. Some implementations would need to change how they implement  backquote. Presumably this is a very isolated change.Cost to Users:  Technically, none. Existing code is not supposed to rely on the distinctions  discussed here. The distinction will only be meaningful when ANSI CL goes into  effect.  In practice, since some implementations will have to change incompatibly,  some code which accidentally relies on the current behavior will break.  However, once such code is fixed, it will be more portable because   implementations will not gratuitously diverge.Cost of Non-Adoption:  An ambiguity would exist in the language, confusing both users and  implementors.Benefits:  An ambiguity would be removed.  Some gratuitous barriers to portability would be removed.Aesthetics:  Proposal DIVERGENT makes things slightly harder to learn.  Both proposals make things more predictably portable, which presumably  has some aesthetic appeal.Discussion:  Pitman thinks that either of these choices will be better than the status quo.  Given that some people already think of ., and ,@ as interchangeable and merely  a matter of personal style, it would be better to go with option INTERCHANGEABLE.        TITAN 
         TITAN 
           >              1                     )                                                        !             Î       7             =      é             ™             ’             l              É              …             º              W       
       _              ¥              ú      ! (zº*start*01808 00024 US Return-Path: <CL-Cleanup-mailer@SAIL.Stanford.EDU>Redistributed: xerox-cl-cleanup^.paReceived: from SAIL.Stanford.EDU ([36.86.0.194]) by Xerox.COM ; 23 JAN 89 08:20:41 PSTReceived: from Think.COM by SAIL.Stanford.EDU with TCP; 23 Jan 89  08:20:38 PSTReceived: from fafnir.think.com by Think.COM; Mon, 23 Jan 89 10:56:42 ESTReturn-Path: <gls@Think.COM>Received: from verdi.think.com by fafnir.think.com; Mon, 23 Jan 89 11:17:02 ESTReceived: by verdi.think.com; Mon, 23 Jan 89 11:15:49 ESTDate: Mon, 23 Jan 89 11:15:49 ESTFrom: Guy Steele <gls@Think.COM>Message-Id: <8901231615.AA12617@verdi.think.com>To: jonl@lucid.comCc: masinter.pa, Gray@dsg.csc.ti.com, KMP@stony-brook.scrc.symbolics.com, CL-Cleanup@sail.stanford.eduIn-Reply-To: Jon L White's message of Mon, 9 Jan 89 19:54:06 PST <8901100354.AA11931@bhopal>Subject: Issue: BACKQUOTE-COMMA-ATSIGN-DOT-COMMA (Version 1)   Date: Mon, 9 Jan 89 19:54:06 PST   From: Jon L White <jonl@lucid.com>   re: The meta-rules for backquote were derived "after the fact" as a way to       explain what backquote did; the use of APPEND and the equivalences there       were based on the old semantics of APPEND. Now that we've extended APPEND,       we have to change the meta-rules of backquote, . . .    Your assumption here can't be true -- The MacLisp implementation (and   others) carried out the now-debased optimization; yet the meta-rules   stand.  I'm very leery of changing these meta rules unless QUUX signs   off on it -- every time I've been tempted to dicker with them, I find   out that they are much deeper than a cursory glanch would suspect.  [I   thought Guy devised those "meta" rules -- if he didn't then the author   ought to be consulted.]I am responsible for the meta-rules in CLtL.--Guy