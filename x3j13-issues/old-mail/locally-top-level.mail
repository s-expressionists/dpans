*start*04639 00024 US Return-Path: <CL-Compiler-mailer@SAIL.Stanford.EDU>Redistributed: xerox-cl-cleanup^.paReceived: from SAIL.Stanford.EDU ([36.86.0.194]) by Xerox.COM ; 09 MAR 89 15:45:38 PSTReceived: from STONY-BROOK.SCRC.Symbolics.COM (SCRC-STONY-BROOK.ARPA) by SAIL.Stanford.EDU with TCP; 9 Mar 89  15:38:57 PSTReceived: from EUPHRATES.SCRC.Symbolics.COM by STONY-BROOK.SCRC.Symbolics.COM via CHAOS with CHAOS-MAIL id 554236; Thu 9-Mar-89 18:36:20 ESTDate: Thu, 9 Mar 89 18:36 ESTFrom: David A. Moon <Moon@STONY-BROOK.SCRC.Symbolics.COM>Subject: Issue: LOCALLY-TOP-LEVEL (Version 1)To: CL-Cleanup@sail.stanford.educc: Sandra J Loosemore <sandra%defun@cs.utah.edu>, CL-Compiler@sail.stanford.eduIn-Reply-To: <8903091815.AA09753@defun.utah.edu>Message-ID: <19890309233609.6.MOON@EUPHRATES.SCRC.Symbolics.COM>This is a cleanup issue, but I'm cc'ing the compiler committeefor their information.Issue:         LOCALLY-TOP-LEVELReferences:    NoneRelated issues: EVAL-WHEN-NON-TOP-LEVEL, DECLARATION-SCOPECategory:      CLARIFICATION / ADDITIONEdit history:  Version 1, 9-Mar-89, by MoonProblem description:  It is desirable to be able to wrap LOCALLY around one or more  top-level forms and have them continue to be treated as top-level  forms.  Three examples of how this is useful:   - to put an OPTIMIZE or INLINE declaration into force around     several related forms.   - to put declarations into force around DEFCLASS, or any other     top-level form that lacks a syntax for embedded declarations.   - DECLARATION-SCOPE:LIMITED-HOISTING, which passed in January,     removed the ability to use a DECLARE at the head of the body of a     DEFUN or DEFMACRO to make a declaration that applies to the entire     form, including the lambda-list.  We are supposed to use LOCALLY     instead, but forms in the body of LOCALLY are not top-level,     and that changes the semantics of DEFMACRO.  Issue EVAL-WHEN-NON-TOP-LEVEL could not define LOCALLY to treat  its body as top-level forms, because only a special form can do  that and LOCALLY is a macro.Proposal (LOCALLY-TOP-LEVEL:SPECIAL-FORM):            Change LOCALLY from a macro to a special form, and change the  definition of compiler processing (in EVAL-WHEN-NON-TOP-LEVEL)  so that when a LOCALLY form appears at top level the forms in  its body are processed at top level.Examples:  (locally (declare (optimize (safety 3) (space 3) (speed 0)))    (defmacro frob (&environment e x y &optional (z (foo x y)))      (mumble x y z e)))  Without this proposal, this would have to be written  (defmacro frob (&environment e x y &optional (z (locally                                                    (declare                                                      (optimize                                                        (safety 3)                                                        (space 3)                                                        (speed 0)))                                                    (foo x y))))    (locally (declare (optimize (safety 3) (space 3) (speed 0)))      (mumble x y z e)))Rationale:  Wrapping LOCALLY around a form should not change its semantics except  as specified by the declarations, hence the body of a top-level  LOCALLY should be top-level.  A macro cannot have a top-level body unless it expands into a special  form that has a top-level body; otherwise the macro invocation and  the macro expansion would not have identical semantics as top-level  forms.  There is no available special form for LOCALLY to macroexpand  into (CLtL doesn't say, but presumably the intent was to expand into  a LET with an empty binding list).Current practice:  The Zetalisp equivalent of LOCALLY worked to surround top-level forms,  because it was a macro that expanded into COMPILER-LET (stashing the  declarations in a special variable the compiler would look at).  This  is of course the wrong way to do declarations, but it shows that the  idea was that you could wrap declarations around a bunch of top-level  forms.  Symbolics Genera 7.4.0 does not implement the proposal (but it does  not implement DECLARATION-SCOPE:LIMITED-HOISTING either).  I did  not survey any other implementations.Cost to Implementors:  A half dozen lines of code in the compiler and a smaller amount  in the interpreter and any program-analyzing programs.Cost to Users:  None.Cost of non-adoption:  See the horrible example above.Performance impact:  None.Benefits:  More consistent language.Esthetics:  Improved.Discussion:  None.*start*01109 00024 US Return-Path: <CL-Compiler-mailer@SAIL.Stanford.EDU>Redistributed: xerox-cl-cleanup^.paReceived: from SAIL.Stanford.EDU ([36.86.0.194]) by Xerox.COM ; 13 MAR 89 15:13:10 PSTReceived: from ECLC.USC.EDU by SAIL.Stanford.EDU with TCP; 13 Mar 89  14:57:25 PSTDate: Sat, 11 Mar 89 19:34:07 PSTFrom: Kim A. Barrett <IIM%ECLA@ECLC.USC.EDU>Subject: Issue LOCALLY-TOP-LEVEL, v1To: Moon@SCRC-STONY-BROOK.ARPAcc: cl-cleanup@SAIL.STANFORD.EDU, cl-compiler@SAIL.STANFORD.EDU, iim%ECLA@ECLC.USC.EDUMessage-ID: <12477306947.30.IIM@ECLA.USC.EDU>This issue arguably ought to be a compiler issue, rather than cleanup, sincethe compiler people seem to be the ones currently mucking about with what wemean by top-level.  (Besides, Larry is overworked as it is :-)More seriously, I support this idea, in part because of the frob example.  Thiskind of thing was one of the reasons I voted against the DECLARATION-SCOPEproposals.By the way, my notes from the Hawaii meeting say that we passed the NO-HOISTINGproposal, and that LIMITED-HOISTING was not even called to a vote.kab-------*start*01832 00024 USaReturn-Path: <CL-Cleanup-mailer@SAIL.Stanford.EDU>Redistributed: xerox-cl-cleanup^.paReceived: from SAIL.Stanford.EDU ([36.86.0.194]) by Xerox.COM ; 13 MAR 89 15:56:39 PSTReceived: from STONY-BROOK.SCRC.Symbolics.COM (SCRC-STONY-BROOK.ARPA) by SAIL.Stanford.EDU with TCP; 13 Mar 89  15:55:08 PSTReceived: from EUPHRATES.SCRC.Symbolics.COM by STONY-BROOK.SCRC.Symbolics.COM via CHAOS with CHAOS-MAIL id 556199; Mon 13-Mar-89 18:51:17 ESTDate: Mon, 13 Mar 89 18:51 ESTFrom: David A. Moon <Moon@STONY-BROOK.SCRC.Symbolics.COM>Subject: Issue LOCALLY-TOP-LEVEL, v1To: Kim A. Barrett <IIM%ECLA@ECLC.USC.EDU>cc: cl-cleanup@SAIL.STANFORD.EDU, cl-compiler@SAIL.STANFORD.EDUIn-Reply-To: <12477306947.30.IIM@ECLA.USC.EDU>Message-ID: <19890313235118.7.MOON@EUPHRATES.SCRC.Symbolics.COM>    Date: Sat 11 Mar 89 19:34:07-PST    From: Kim A. Barrett <IIM%ECLA@ECLC.USC.EDU>    This issue arguably ought to be a compiler issue, rather than cleanup, since    the compiler people seem to be the ones currently mucking about with what we    mean by top-level.  (Besides, Larry is overworked as it is :-)I may have sent it to the wrong committee by mistake.  If either Sandra orLarry instructs me to send it to the other committee, I'll do so forthwith.    More seriously, I support this idea, in part because of the frob example.  This    kind of thing was one of the reasons I voted against the DECLARATION-SCOPE    proposals.    By the way, my notes from the Hawaii meeting say that we passed the NO-HOISTING    proposal, and that LIMITED-HOISTING was not even called to a vote.You're right, I copied down the wrong proposal name.  What I said aboutit is true of the NO-HOISTING proposal but false of the LIMITED-HOISTINGproposal.  This needs to be fixed before it's distributed more widely.*start*01252 00024 US GV-Info: CL-Cleanup-mailer@SAIL.Stanford.EDU at 15-Mar-89 18:55:48 from AGReturn-Path: <CL-Cleanup-mailer@SAIL.Stanford.EDU>Redistributed: xerox-cl-cleanup^.paReceived: from SAIL.Stanford.EDU ([36.86.0.194]) by Xerox.COM ; 15 MAR 89 18:55:47 PSTMessage-ID: <9vuaR@SAIL.Stanford.EDU>Date: 15 Mar 89 17:56 PSTFrom: System Files <SYS@SAIL.Stanford.EDU>Subject: Re: Issue LOCALLY-TOP-LEVEL, v1Received: from Xerox.COM by SAIL.Stanford.EDU with TCP; 15 Mar 89  17:56:39 PSTReceived: from Cabernet.ms by ArpaGateway.ms ; 15 MAR 89 17:24:03 PSTDate: 15 Mar 89 17:23 PSTFrom: masinter.pa@Xerox.COMSubject: Re: Issue LOCALLY-TOP-LEVEL, v1In-reply-to: David A. Moon <Moon@STONY-BROOK.SCRC.Symbolics.COM>'s message of Mon, 13 Mar 89 18:51 ESTTo: David A. Moon <Moon@STONY-BROOK.SCRC.Symbolics.COM>cc: Kim A. Barrett <IIM%ECLA@ECLC.USC.EDU>, cl-cleanup@SAIL.STANFORD.EDU, cl-compiler@SAIL.STANFORD.EDUMessage-ID: <890315-172403-1288@Xerox>I don't care what committee you send it to, but since Sandra has alreadyfinished her list of proposals and I'm still working on mine, you might aswell get it on mine. Cleanup has more time, anyway.It looked like it only needed the minor edit to fix the NO-HOSTINGallusion.*start*04718 00024 US GV-Info: X3J13-mailer@SAIL.Stanford.EDU at 17-Mar-89 08:50:58 from AGReturn-Path: <X3J13-mailer@SAIL.Stanford.EDU>Received: from SAIL.Stanford.EDU ([36.86.0.194]) by Xerox.COM ; 17 MAR 89 08:47:29 PSTReceived: from STONY-BROOK.SCRC.Symbolics.COM (SCRC-STONY-BROOK.ARPA) by SAIL.Stanford.EDU with TCP; 17 Mar 89  08:34:33 PSTReceived: from EUPHRATES.SCRC.Symbolics.COM by STONY-BROOK.SCRC.Symbolics.COM via CHAOS with CHAOS-MAIL id 559504; Fri 17-Mar-89 11:31:57 ESTDate: Fri, 17 Mar 89 11:31 ESTFrom: David A. Moon <Moon@STONY-BROOK.SCRC.Symbolics.COM>Subject: Issue: LOCALLY-TOP-LEVEL (Version 2)To: X3J13@sail.stanford.eduReferences: <19890309233609.6.MOON@EUPHRATES.SCRC.Symbolics.COM>Message-ID: <19890317163159.3.MOON@EUPHRATES.SCRC.Symbolics.COM>This is a cleanup committee issue.  It could have been in thecompiler committee, but as it happens it ended up in thecleanup committee.Issue:         LOCALLY-TOP-LEVELReferences:    NoneRelated issues: EVAL-WHEN-NON-TOP-LEVEL, DECLARATION-SCOPECategory:      CLARIFICATION / ADDITIONEdit history:  Version 1,  9-Mar-89, by Moon               Version 2, 16-Mar-89, by Moon, fix referenced proposal nameProblem description:  It is desirable to be able to wrap LOCALLY around one or more  top-level forms and have them continue to be treated as top-level  forms.  Three examples of how this is useful:   - to put an OPTIMIZE or INLINE declaration into force around     several related forms.   - to put declarations into force around DEFCLASS, or any other     top-level form that lacks a syntax for embedded declarations.   - DECLARATION-SCOPE:NO-HOISTING, which passed in January,     removed the ability to use a DECLARE at the head of the body of a     DEFUN or DEFMACRO to make a declaration that applies to the entire     form, including the lambda-list.  We are supposed to use LOCALLY     instead, but forms in the body of LOCALLY are not top-level,     and that changes the semantics of DEFMACRO.  Issue EVAL-WHEN-NON-TOP-LEVEL could not define LOCALLY to treat  its body as top-level forms, because only a special form can do  that and LOCALLY is a macro.Proposal (LOCALLY-TOP-LEVEL:SPECIAL-FORM):            Change LOCALLY from a macro to a special form, and change the  definition of compiler processing (in EVAL-WHEN-NON-TOP-LEVEL)  so that when a LOCALLY form appears at top level the forms in  its body are processed at top level.Examples:  (locally (declare (optimize (safety 3) (space 3) (speed 0)))    (defmacro frob (&environment e x y &optional (z (foo x y)))      (mumble x y z e)))  Without this proposal, this would have to be written  (defmacro frob (&environment e x y &optional (z (locally                                                    (declare                                                      (optimize                                                        (safety 3)                                                        (space 3)                                                        (speed 0)))                                                    (foo x y))))    (locally (declare (optimize (safety 3) (space 3) (speed 0)))      (mumble x y z e)))Rationale:  Wrapping LOCALLY around a form should not change its semantics except  as specified by the declarations, hence the body of a top-level  LOCALLY should be top-level.  A macro cannot have a top-level body unless it expands into a special  form that has a top-level body; otherwise the macro invocation and  the macro expansion would not have identical semantics as top-level  forms.  There is no available special form for LOCALLY to macroexpand  into (CLtL doesn't say, but presumably the intent was to expand into  a LET with an empty binding list).Current practice:  The Zetalisp equivalent of LOCALLY worked to surround top-level forms,  because it was a macro that expanded into COMPILER-LET (stashing the  declarations in a special variable the compiler would look at).  This  is of course the wrong way to do declarations, but it shows that the  idea was that you could wrap declarations around a bunch of top-level  forms.  Symbolics Genera 7.4.0 does not implement the proposal (but it does  not implement DECLARATION-SCOPE:NO-HOISTING either).  I did  not survey any other implementations.Cost to Implementors:  A half dozen lines of code in the compiler and a smaller amount  in the interpreter and any program-analyzing programs.Cost to Users:  None.Cost of non-adoption:  See the horrible example above.Performance impact:  None.Benefits:  More consistent language.Esthetics:  Improved.Discussion:  None.*start*01423 00024 US Date:  4 Apr 89 12:29 PDTSender: CL-Cleanup-mailer%SAIL.Stanford:EDU:XeroxFrom: KMP%STONY-BROOK.SCRC.Symbolics:COM:XeroxSubject: Issue: LOCALLY-TOP-LEVELTo: CL-Cleanup%SAIL.Stanford:EDU:Xeroxcc: Dick%Wheaties.AI.MIT:EDU:XeroxGVGVGVGVGVGVGVGVGVGVGVGVGVGVGVGVGVGVGVGVGVGVGVGVGVFrom: Kent M Pitman <KMP@STONY-BROOK.SCRC.Symbolics.COM>Subject: Issue: LOCALLY-TOP-LEVELTo: CL-Cleanup@SAIL.Stanford.EDUcc: Dick@Wheaties.AI.MIT.EDUReturn-Path: <CL-Cleanup-mailer@SAIL.Stanford.EDU>Redistributed: xerox-cl-cleanup^.paReceived: from SAIL.Stanford.EDU ([36.86.0.194]) by Xerox.COM ; 04 APR 89 12:21:21 PDTReceived: from STONY-BROOK.SCRC.Symbolics.COM by SAIL.Stanford.EDU with TCP; 4 Apr 89  12:19:22 PDTReceived: from BOBOLINK.SCRC.Symbolics.COM by STONY-BROOK.SCRC.Symbolics.COM via CHAOS with CHAOS-MAIL id 571209; Tue 4-Apr-89 15:19:16 EDTOriginal-Date: Tue, 4 Apr 89 15:18 EDTMessage-ID: <890404151849.3.KMP@BOBOLINK.SCRC.Symbolics.COM>GVGVGVGVGVGVGVGVGVGVGVGVGVGVGVGVGVGVGVGVGVGVGVGVGV[Waters added for sake of amusing story at end.]My notes say this passed unanimously.I also noted that this took 15 seconds to vote in. In fact, we did itwhile in the middle of PRETTY-PRINT-INTERFACE sort of at ``interrupt level''in a way that confused Mary's taking of the minutes and we -almost- gotthe pretty printer marked as voted in because she didn't realize we'd shifted topics.